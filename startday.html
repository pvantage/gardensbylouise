<!doctype html>
<html lang="en">
<head>
<title>Gardens By Louise LLC</title>
<!-- Required meta tags -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<!-- Bootstrap CSS -->
<link rel="stylesheet" href="css/bootstrap.min.css">
<link rel="stylesheet" href="css/font-awesome.min.css">
<link rel="stylesheet" href="css/fonts-styles.css">
<link rel="stylesheet" href="css/style.css">
<link rel="stylesheet" href="css/jquery-ui.css">
<link rel="stylesheet" href="css/mycss.css">
</head>
<body class="light-grey-bg after-login schlbody">
<!----- Header Top ----->
<div class="container mysch-fix-hdr">
  <div class="header-top">
    <div class="row  align-items-center">
	<img src="images/hdr-logo.png" alt="header-logo" />
    </div>
  </div>
</div>
<!----- /Header Top ----->
<input type="hidden" id="job_id" value="0" />
<div class="clearfix"></div>
<div class="container cntbox tab-content timerbx">
  <div id="home" class="tab-pane fade in active show">
    <h1 class="myschle">Today's Timesheet</h1>
   
	<div class="start_list">
	<ul class="starttodayjob_times">
		<li><label>General Clock:</label><span class="general_clock_time" data-real-time=""></span></li>
		<li><label>Job Clock:</label><span class="job_clock_time" data-real-time=""></span></li>
	</ul>
	<button class="str-job starttodayjob"></button>
	<div class="clearfix"></div>
	<div class="startjob_status_text offclock_st_color"></div>
	<div class="previous_notes"></div>
	</div>
  </div>
  
</div>
<!----- Bottom Nav Bar ----->
<div class="bottom-nav-bar"></div>
<!----- /Bottom Nav Bar -----> 

<!-- Optional JavaScript --> 
<!-- jQuery first, then Popper.js, then Bootstrap JS --> 

<div id="myModal1" class="modal fade bottom-popup" role="dialog">
  <div class="modal-dialog"> 
    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-body">
        <div class="pop-cnt">
          <div class="pop-btm-cnt">
            <ul>
              <li class="nojobexist"><a href="javascript:;" class="accept_job">Pick the job you want to clock into</a></li>
			  <li> <a class="decline_job" href="javascript:;">Clock In General Timer For The Day</a></li>
            </ul>
          </div>
          <div class="pop-btm-cnt pop-cancel">
            <ul>
              
			  <li> <a href="javascript:;" data-dismiss="modal">Cancel</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<div id="myModal2" class="modal fade bottom-popup" role="dialog">
  <div class="modal-dialog"> 
    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-body">
        <div class="pop-cnt">
          <div class="pop-btm-cnt">
            <ul>
              <li class="nojobexist"><a href="javascript:;" class="step2_newxt_job">Clock Out Of Job</a></li>
			  <li><a href="javascript:;" class="checkforclockout">Clock out for day</a></li>
			  <li><a href="javascript:;" class="step2_stop_for_lunch">Clock Out For Lunch Or Break</a></li>
            </ul>
          </div>
          <div class="pop-btm-cnt pop-cancel">
            <ul>
              <li> <a href="javascript:;" data-dismiss="modal">Cancel</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<div id="myModal3" class="modal fade bottom-popup" role="dialog">
  <div class="modal-dialog"> 
    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-body">
        <div class="pop-cnt">
          <div class="pop-btm-cnt">
            <ul>
              <li class="nojobexist"><a href="javascript:;" class="step3_newxt_job">Clock in to job</a></li>
			  <li><a href="javascript:;" class="checkforclockout">Clock out for day</a></li>
			  <li><a href="javascript:;" class="step2_stop_for_lunch">Clock Out For Lunch Or Break</a></li>
            </ul>
          </div>
          <div class="pop-btm-cnt pop-cancel">
            <ul>
              <li> <a href="javascript:;" data-dismiss="modal">Cancel</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<div id="myModal4" class="modal fade bottom-popup" role="dialog">
  <div class="modal-dialog"> 
    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-body">
        <div class="pop-cnt">
			<p class="alertmsg"></p>
          <div class="pop-btm-cnt">
		  	
            <ul>
			  <li><a href="javascript:;" class="step2_stopclocks">Yes</a></li>
            </ul>
          </div>
          <div class="pop-btm-cnt pop-cancel">
            <ul>
              <li> <a href="javascript:;" data-dismiss="modal">No</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<div id="addnewnotes" class="modal fade popupformats taskpopup" role="dialog">
  <div class="modal-dialog"> 
    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-body">
        <div class="pop-head">
          <div class="row">
            <a href="javascript:;" data-dismiss="modal" class="close col-2 donbtn gottoback">Cancel</a>
            <div class="col-10 pop-title">Add Notes</div>
          </div>
        </div>
        <div class="new-forms-formats">
			<form id="noteform" name="noteform" action="" method="post">
			
		  <div class="nf-box">
			<textarea name="notemsg" id="notemsg" rows="3" cols="50" class="required forminput"></textarea>
          </div>
          <div class="nf-box">
           <button class="nf-box-btn savenewnote" type="button">Save</button>
          </div>
          
		  </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="js/jquery-3.2.1.min.js" ></script>
<script src="js/jquery-ui.min.js" ></script>
<script src="js/popper.min.js" ></script> 
<script src="js/bootstrap.min.js" ></script>
<script type="text/javascript" charset="utf-8" src="cordova.js"></script>
<script type="text/javascript">
rebute=false;
</script>
<script type="text/javascript" src="js/config.js"></script>
<script type="text/javascript" src="js/database.js"></script>
<script type="text/javascript">

function addeditform(){
	
	var job_id=jQuery('#job_id').val();
	window.location='form.html?job_id='+job_id;
		
}
var timecount=0;
var counter='';
var timecount2=0;
var counter2='';
function gettimediff(time1,time2){
	var tms=time1.split(' ');
	var ds=tms[0].split('-');
	var ts=tms[1].split(':');
	time1=ds[1]+'/'+ds[2]+'/'+ds[0]+' '+tms[1];
	
	var tms=time2.split(' ');
	var ds=tms[0].split('-');
	var ts=tms[1].split(':');
	time2=ds[1]+'/'+ds[2]+'/'+ds[0]+' '+tms[1];
	var date1 = new Date(time1);
	var date2 = new Date(time2);
	var diff = date2.getTime() - date1.getTime();
	var msec = parseInt(diff);
	var hh = Math.floor(msec / 1000 / 60 / 60);
	msec -= hh * 1000 * 60 * 60;
	var mm = Math.floor(msec / 1000 / 60);
	msec -= mm * 1000 * 60;
	var ss = Math.floor(msec / 1000);
	msec -= ss * 1000;
	
	if(parseInt(hh)<10){hh='0'+hh;}
	if(parseInt(mm)<10){mm='0'+mm;}
	if(parseInt(ss)<10){ss='0'+ss;}
	return hh + ":" + mm + ":" + ss;
}
function generaltimer(){
	var playcounter=true;
	var stop_general_clock=localStorage.getItem('stop_general_clock_'+today);
	
	if(typeof stop_general_clock!='undefined' && stop_general_clock=='stop'){
		clearInterval(counter);
		playcounter=false;
	}
	if(playcounter)
	{
		timecount=parseInt(timecount)+1000;
		timecount=parseInt(timecount);
		var hours = Math.floor((timecount % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
		var minutes = Math.floor((timecount % (1000 * 60 * 60)) / (1000 * 60));
		var seconds = Math.floor((timecount % (1000 * 60)) / 1000);
		if(parseInt(hours)<10){hours='0'+parseInt(hours);}
		if(parseInt(minutes)<10){minutes='0'+parseInt(minutes);}
		if(parseInt(seconds)<10){seconds='0'+parseInt(seconds);}
		var waittime=hours+':'+minutes+':'+seconds;
		jQuery('.general_clock_time').html(waittime);
		localStorage.setItem('general_'+today,waittime);
		localStorage.setItem('timecount',timecount);
	}
	
	
}
function jobtimer(){
	var playcounter=true;
	var stop_job_clock=localStorage.getItem('stop_job_clock_'+today);
	if(typeof stop_job_clock!='undefined' && stop_job_clock=='stop'){
		clearInterval(counter2);
		playcounter=false;
	}
	if(playcounter)
	{
		timecount2=parseInt(timecount2)+1000;
		timecount2=parseInt(timecount2);
		var hours = Math.floor((timecount2 % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
		var minutes = Math.floor((timecount2 % (1000 * 60 * 60)) / (1000 * 60));
		var seconds = Math.floor((timecount2 % (1000 * 60)) / 1000);
		if(parseInt(hours)<10){hours='0'+parseInt(hours);}
		if(parseInt(minutes)<10){minutes='0'+parseInt(minutes);}
		if(parseInt(seconds)<10){seconds='0'+parseInt(seconds);}
		var waittime=hours+':'+minutes+':'+seconds;
		jQuery('.job_clock_time').html(waittime);
		localStorage.setItem('job_'+today,waittime);
		localStorage.setItem('timecount2',timecount2);
	}
	
}
function loadjob(job_id){
	var job_id2=localStorage.getItem('finish_job');
	
	var finish_today_job=localStorage.getItem('finish_today_job');
	//alert(job_id);
	if(finish_today_job==today){
		return false;
	}
	if(job_id!=job_id2){
		var currentdatetime=getdatetime();
		var currenttime=getcurrenttime();
		db.transaction(showlistjobs, errorDB, successDB);
		var job_status=localStorage.getItem('job_status_'+today);
		function showlistjobs(tx){
			var q="SELECT * FROM jobs WHERE job_id=? AND user_id=?";
			var cond=[job_id,uid];
			tx.executeSql(q, cond, function(tx, res){
				if(parseInt(res.rows.length)>0){
					for(var i = 0; i < res.rows.length; i++)
					{
						if(res.rows.item(i).status=='Assigned'){
							tx.executeSql("UPDATE jobs set status='Being Processed', real_date='"+today+"', real_start_time='"+currenttime+"' WHERE job_id='"+job_id+"' AND user_id='"+uid+"'");
							tx.executeSql("UPDATE job_daytimes set job_id='"+job_id+"', status='process' WHERE start_date='"+today+"' AND user_id='"+uid+"'");
							tx.executeSql('INSERT INTO job_times (job_id, assigned_to, pu_date, start_time, time_type, cdate) VALUES ("'+job_id+'", "'+uid+'","'+today+'", "'+currenttime+'","startjob", "'+currentdatetime+'")');
							
							var q2="SELECT * FROM job_schedule WHERE job_date=? AND user_id=?";
							var cond2=[today,uid];
							tx.executeSql(q2, cond2, function(tx, res2){
								if(parseInt(res2.rows.length)>0){
									var last_job_id=res2.rows.item(parseInt(res2.rows.length)-1).job_id;
									if(job_status=='stopforday')
									{
										tx.executeSql('INSERT INTO job_schedule (job_id, startfrom, endto, job_date, last_job_id, user_id, cdate) VALUES ("'+job_id+'", "office", "job","'+today+'", "0", "'+uid+'", "'+currentdatetime+'")');
									}
									else{
										tx.executeSql('INSERT INTO job_schedule (job_id, startfrom, endto, job_date, last_job_id, user_id, cdate) VALUES ("'+job_id+'", "job", "job","'+today+'", "'+last_job_id+'", "'+uid+'", "'+currentdatetime+'")');
									}
								}
								else{
									
									tx.executeSql('INSERT INTO job_schedule (job_id, startfrom, endto, job_date, last_job_id, user_id, cdate) VALUES ("'+job_id+'", "office", "job","'+today+'", "0", "'+uid+'", "'+currentdatetime+'")');
								}
							});
							localStorage.removeItem('stop_job_clock_'+today);
							localStorage.removeItem('stop_general_clock_'+today);
							localStorage.removeItem('finish_job');
							localStorage.removeItem('stop_today_'+today);
						}
						jQuery('.previous_notes').html('<button type="button" class="nf-box-btn addformbtn" onclick="addeditform();">Form</button><div class="clearfix"></div><button type="button" class="nf-box-btn" data-toggle="modal" data-target="#addnewnotes">Add Note</button>');
						var q="SELECT * FROM job_notifications WHERE job_id=? AND title=? ORDER BY cdate DESC";
						var cond=[job_id,'Note'];
						tx.executeSql(q, cond, function(tx, res2){
							if(parseInt(res2.rows.length)>0){
								var html='<button type="button" class="nf-box-btn addformbtn" onclick="addeditform();">Form</button><div class="clearfix"></div><button type="button" class="nf-box-btn" data-toggle="modal" data-target="#addnewnotes">Add Note</button><h2></h2>';
								for(var i = 0; i < res2.rows.length; i++)
								{
									var daytim=res2.rows.item(i).cdate;
									var daytims=daytim.split(' ');
									//alert(daytims);
									var dts=daytims[0].split('-');
									var tms=daytims[1].split(':');
									var sd=dts[1]+'/'+dts[2]+'/'+dts[0];
									var st=tms[0]+':'+tms[1]+' AM';
									if(parseInt(tms[0])>11){
										st=tms[0]+':'+tms[1]+' PM';
									}
									html+='<div class="job-notes"><p>'+res2.rows.item(i).add_by+', '+sd+', '+st+': '+res2.rows.item(i).message+'</p></div>';
								}
								jQuery('.previous_notes').html(html);
							}
						});
						
						var startjob_status_text2=localStorage.getItem('startjob_status_text');
						if(startjob_status_text2!='Clocked out for lunch or break'){
							localStorage.setItem('startjob_status_text','Clocked In: '+res.rows.item(i).address);
							var startjob_status_text=localStorage.getItem('startjob_status_text');
							jQuery('.startjob_status_text').html(startjob_status_text);
						}
						var newtimecount=localStorage.getItem('timecount2');
						if(typeof newtimecount!='undefined' && newtimecount!='' && newtimecount!=null){
							timecount2=newtimecount;
						}
						clearInterval(counter2);
						counter2=setInterval(jobtimer, 1000);
						if(startjob_status_text2!='Clocked out for lunch or break'){
							jQuery('.job_clock_time').parents('li').addClass('clock_active');
						}
						jQuery('.general_clock_time').parents('li').addClass('glck');
						/*var generaltime=localStorage.getItem('general_'+today);
						if(typeof generaltime!='undefined' && generaltime!='' && generaltime!=null){
							if(generaltime=='00:00:00'){
								timecount=localStorage.getItem('timecount');
								if(typeof timecount!='undefined' && timecount!='' && timecount!=null){
									counter=setInterval(generaltimer, 1000);
								}
							}
						}*/
						
					}
					//alert('test');
					localStorage.setItem('job_status_'+today,'jobstart');
					jQuery('.starttodayjob').removeClass('step3');
					jQuery('.starttodayjob').addClass('step2');
				}
				jQuery('#job_id').val(job_id);
			});
			
		}
	}
	else if(job_id2!='undefined' && job_id2!=null && job_id2!='')
	{
		jQuery('.starttodayjob').removeClass('step3');
		jQuery('.starttodayjob').addClass('step2');
	}
}
function clockouttime(){
	/*localStorage.setItem('startjob_status_text','You Are Currently Off the Clock');
	localStorage.setItem('stop_job_clock_'+today,'stop');
	localStorage.setItem('stop_general_clock_'+today,'stop');
	localStorage.setItem('stop_today_'+today,'stop');
	jQuery('.startjob_status_text').html('You Are Currently Off the Clock');
	jQuery('.job_clock_time').parents('li').removeClass('clock_active');
	clearInterval(counter);
	clearInterval(counter2);
	jQuery('#myModal1').modal('hide');*/
	var currenttime=getcurrenttime();
	db.transaction(startlunch, errorDB, successDB);
	function startlunch(tx){
		tx.executeSql("UPDATE job_daytimes set end_time='"+currenttime+"' AND status='complete' WHERE start_date='"+today+"' AND user_id='"+uid+"'");
	}
	jQuery('#myModal4 .alertmsg').html('Are you sure you want to close the day?');
	jQuery('#myModal1').modal('hide');
	jQuery('#myModal2').modal('hide');
	jQuery('#myModal3').modal('hide');
	jQuery('#myModal4').modal();
}
function synjobs(){
	localStorage.setItem('StaffMem_synjobs','done');
	checkfornewupdates();
	jQuery('#myModal1').modal('hide');
	jQuery('body .showmessage').remove();
		var html='<div class="showmessage">Synchronize data from server.</div>';
		jQuery('body').append(html);
		setTimeout(function(){
			jQuery('.showmessage').slideUp();
			localStorage.removeItem('StaffMem_synjobs');
			window.location='';
		},4000);
}
jQuery(document).ready(function(){
	
	jQuery( document ).on( "mobileinit", function() {
		jQuery.mobile.allowCrossDomainPages = true;
	});
	var contentType ="application/x-www-form-urlencoded; charset=utf-8";
    if(window.XDomainRequest){contentType = "text/plain";}
	var uid=localStorage.getItem('StaffMem_ID');
	if(typeof uid=='undefined' || uid=='' || uid==null){
		checkloggedin();
	}
	jQuery.support.cors = true;
	var job_id=gup('job_id');
	if(job_id!='' && job_id!='undefined' && job_id!=null){
		localStorage.removeItem('finish_today_job');
	}
	loadjob(job_id);
	
	var jobdone=gup('jobdone');
	if(jobdone=='1'){
		jQuery('.starttodayjob').addClass('step3');
		setTimeout(function(){jQuery('.starttodayjob').removeClass('step2');},1500);
	}
	var finish_today_job=localStorage.getItem('finish_today_job');
	if(finish_today_job==today){
		//jQuery('#myModal1').remove();
		//jQuery('#myModal2').remove();
		//jQuery('#myModal3').remove();
		//jQuery('#myModal4').remove();
		jQuery('.starttodayjob_times li').removeClass('glck');
		localStorage.setItem('startjob_status_text','Clocked Out For Day');
		jQuery('.startjob_status_text').addClass('daycompleted');
		setTimeout(function(){
			jQuery('.starttodayjob').removeClass('step2');
			jQuery('.starttodayjob').addClass('step3');
			jQuery('.startjob_status_text').html('Clocked Out For Day');
			jQuery('.starttodayjob_times li').removeClass('glck');
			jQuery('.startjob_status_text').addClass('daycompleted');
		},150);
	}
	
	var generaltime=localStorage.getItem('general_'+today);
	if(typeof generaltime!='undefined' && generaltime!='' && generaltime!=null){
		if(generaltime!='00:00:00'){
			var job_status=localStorage.getItem('job_status_'+today);
			if(job_status=='jobstart'){
				jQuery('.starttodayjob').removeClass('step3');
				jQuery('.starttodayjob').addClass('step2');
			}
			else if(job_status=='traveltonext'){
				jQuery('.starttodayjob').removeClass('step2');
				jQuery('.starttodayjob').addClass('step3');
			}
			else if(job_status=='startgeneraltime'){
				jQuery('.decline_job').parent('li').remove();
			}
			else if(job_status=='lunchbreak'){
				jQuery('.starttodayjob').removeClass('step3');
				jQuery('.starttodayjob').addClass('step2');
				setTimeout(function(){
					jQuery('.starttodayjob').removeClass('step3');
					jQuery('.starttodayjob').addClass('step2');
				},2000);
			}
			jQuery('.general_clock_time').parents('li').addClass('glck');
			jQuery('.starttodayjob').text('Change Timer State');
			var startjob_status_text=localStorage.getItem('startjob_status_text');
			jQuery('.startjob_status_text').html(startjob_status_text);
			jQuery('.general_clock_time').html(generaltime);
			var job_timer=localStorage.getItem('job_'+today);
			jQuery('.job_clock_time').html(job_timer);
			if(startjob_status_text!='You are currently off the clock'){
				jQuery('.startjob_status_text').removeClass('offclock_st_color');
			}
			if(startjob_status_text=='Clocked In: No Active Job'){
				jQuery('#myModal1 .pop-btm-cnt:first ul li.clockoutmenu').remove();
				jQuery('#myModal1 .pop-btm-cnt:first ul').append('<li class="clockoutmenu"><a href="javascript:;" onclick="clockouttime();">Clock out for day</a></li>');
			}
			
			db.transaction(startdaytime2, function(){}, successDB);
			function startdaytime2(tx){
				var q="SELECT * FROM job_daytimes WHERE start_date=?";
				var cond=[today];
				tx.executeSql(q, cond, function(tx, res){
					if(parseInt(res.rows.length)>0){
						var time1=res.rows.item(0).start_date+' '+res.rows.item(0).start_time;
						var time2=getdatetime();
						var wattime=gettimediff(time1,time2);
						wattime=wattime.split(':');
						
						timecount=(parseInt(wattime[0])*60*60*1000)+(parseInt(wattime[1])*60*1000)+(parseInt(wattime[2])*1000);
						//alert(wattime+'='+timecount);
						counter=setInterval(generaltimer, 1000);
						var jobid=res.rows.item(0).job_id;
						if(typeof jobid!='undefined' && jobid!='' && jobid!=null && (typeof job_id=='undefined' || jobid==null)){
							timecount2=0;
							loadjob(jobid);
							if(job_status=='traveltonext'){
								jQuery('.starttodayjob').removeClass('step2');
								jQuery('.starttodayjob').addClass('step3');
							}
							
						}
					}
				});
				
			}
			
		}
		else{
			jQuery('.starttodayjob').text('Change Timer State');
			var startjob_status_text=localStorage.getItem('startjob_status_text');
			if(startjob_status_text=='You are currently off the clock'){
				jQuery('.startjob_status_text').addClass('offclock_st_color');
			}
			jQuery('.startjob_status_text').html(startjob_status_text);
			jQuery('.general_clock_time').html('00:00:00');
			jQuery('.job_clock_time').html('00:00:00');
			
			
		}
	}
	else{
		localStorage.setItem('general_'+today,'00:00:00');
		localStorage.setItem('job_'+today,'00:00:00');
		jQuery('.starttodayjob').text('Change Timer State');
		localStorage.setItem('startjob_status_text','You are currently off the clock');
		jQuery('.startjob_status_text').html('You are currently off the clock');
		jQuery('.general_clock_time').html('00:00:00');
		jQuery('.job_clock_time').html('00:00:00');
		
	}
	jQuery('.checkforclockout').click(function(){
		jQuery('#myModal2').modal('hide');
		jQuery('#myModal3').modal('hide');
		jQuery('#myModal4 .alertmsg').html('Are you sure you want to close the job?');
		jQuery('#myModal4').modal();
		
	});
	jQuery('.starttodayjob').click(function(){
		
		if(!jQuery('.starttodayjob').hasClass('step2') && !jQuery('.starttodayjob').hasClass('step3')){
			var generaltime=localStorage.getItem('general_'+today);
			jQuery('#myModal1').modal();
		}
		else if(jQuery('.starttodayjob').hasClass('step2') && !jQuery('.starttodayjob').hasClass('step3')){
			jQuery('#myModal2').modal();
		}
		else if(jQuery('.starttodayjob').hasClass('step3') && !jQuery('.starttodayjob').hasClass('step2')){
			jQuery('#myModal3').modal();
		}
	});
	jQuery('.step2_newxt_job').click(function(){
		localStorage.setItem('startjob_status_text','Clocked In: No Active Job');
		localStorage.setItem('stop_job_clock_'+today,'stop');
		localStorage.setItem('job_status_'+today,'traveltonext');
		jQuery('.startjob_status_text').html('Clocked In: No Active Job');
		clearInterval(counter2);
		var job_id=jQuery('#job_id').val();
		var job_id2=localStorage.getItem('finish_job');
		if(job_id!=job_id2 && job_id!='' && job_id!='0'){
			jQuery('#myModal2').modal('hide');
			//jQuery('#addjobform').modal();
			var currentdatetime=getdatetime();
			var endtime=getcurrenttime();
			db.transaction(travelnewjob, errorDB, successDB);
			function travelnewjob(tx){
				var qry="UPDATE jobs set status='Completed', real_end_time='"+endtime+"' WHERE job_id='"+job_id+"' AND  user_id='"+uid+"'";
				tx.executeSql(qry);
				var uq="UPDATE job_times set end_time='"+endtime+"' WHERE pu_date='"+today+"' AND assigned_to='"+uid+"' AND job_id='"+job_id+"' AND time_type='startjob' AND end_time='00:00:00'";
				tx.executeSql(uq);
				localStorage.setItem('finish_job',job_id);
				localStorage.removeItem('timecount2');
				var q="SELECT * FROM job_schedule WHERE job_id=? AND user_id=? AND job_date=?";
				var cond=[job_id,uid,today];
				tx.executeSql(q, cond, function(tx, res){
					if(parseInt(res.rows.length)>0){
						var cdate=res.rows.item(0).cdate;
						var tms=cdate.split(' ');
						var qr='INSERT INTO job_totaltime (job_id, staff_id, job_date, start_time, end_time, cdate) VALUES ("'+job_id+'", "'+uid+'", "'+today+'", "'+tms[1]+'", "'+endtime+'", "'+currentdatetime+'")';
						tx.executeSql(qr);
						window.location='startday.html?jobdone=1';
					}
				});
				
				
			}
		}
		else{
			jQuery('#myModal2').modal('hide');
			window.location='today-jobs.html';
		}
	});
	
	jQuery('.step3_newxt_job').click(function(){
		localStorage.setItem('startjob_status_text','Clocked In: No Active Job');
		jQuery('.startjob_status_text').html('Clocked In: No Active Job');
		jQuery('.startjob_status_text').addClass('decline_job_status');
		window.location='today-jobs.html';
	});
	
	jQuery('.step2_stopclocks').click(function(){
		localStorage.setItem('job_status_'+today,'stopforday');
		localStorage.setItem('startjob_status_text','You Are Currently Off the Clock');
		localStorage.setItem('stop_job_clock_'+today,'stop');
		localStorage.setItem('stop_general_clock_'+today,'stop');
		localStorage.setItem('stop_today_'+today,'stop');
		jQuery('.starttodayjob_times li').removeClass('glck');
		jQuery('.startjob_status_text').html('You Are Currently Off the Clock');
		jQuery('.job_clock_time').parents('li').removeClass('clock_active');
		jQuery('.startjob_status_text').addClass('daycompleted');
		clearInterval(counter);
		clearInterval(counter2);
		var job_id=jQuery('#job_id').val();
		var redirect=true;
		var job_id2=localStorage.getItem('finish_job');
		localStorage.setItem('finish_today_job',today);
		if(job_id!=job_id2 && job_id!='' && job_id!='undefined' && job_id!='0'){
			jQuery('#myModal2').modal('hide');
			//jQuery('#addjobform').modal();
			redirect=false;
			var currentdatetime=getdatetime();
			var endtime=getcurrenttime();
			var endtime2=addasecondintime();
			db.transaction(travelnewjob, errorDB, successDB);
			function travelnewjob(tx){
				var qry="UPDATE jobs set status='Completed', real_end_time='"+endtime+"' WHERE job_id='"+job_id+"' AND  user_id='"+uid+"'";
				tx.executeSql(qry);
				var uq="UPDATE job_times set end_time='"+endtime+"' WHERE pu_date='"+today+"' AND assigned_to='"+uid+"' AND job_id='"+job_id+"' AND time_type='startjob' AND end_time='00:00:00'";
				tx.executeSql(uq);
				var qr="UPDATE job_daytimes set end_time='"+endtime+"', status='complete' WHERE start_date='"+today+"' AND user_id='"+uid+"'";
				tx.executeSql(qr);
				localStorage.removeItem('timecount');
				localStorage.removeItem('timecount2');
				
				var q="SELECT * FROM job_schedule WHERE job_id=? AND user_id=? AND job_date=?";
				var cond=[job_id,uid,today];
				tx.executeSql(q, cond, function(tx, res){
					if(parseInt(res.rows.length)>0){
						var cdate=res.rows.item(0).cdate;
						var sid=res.rows.item(0).id;
						var last_job_id=res.rows.item(0).job_id;
						var tms=cdate.split(' ');
						var qr='INSERT INTO job_totaltime (job_id, staff_id, job_date, start_time, end_time, cdate) VALUES ("'+job_id+'", "'+uid+'", "'+today+'", "'+tms[1]+'", "'+endtime+'", "'+currentdatetime+'")';
						tx.executeSql(qr);
						tx.executeSql('INSERT INTO job_schedule (job_id, startfrom, endto, job_date, last_job_id, user_id, cdate) VALUES ("'+job_id+'", "job", "office","'+today+'", "'+last_job_id+'", "'+uid+'", "'+currentdatetime+'")');
						
						tx.executeSql('INSERT INTO job_times (job_id, assigned_to, pu_date, start_time, end_time, time_type, cdate) VALUES ("'+job_id+'", "'+uid+'","'+today+'", "'+endtime+'", "'+endtime2+'","stopjob", "'+currentdatetime+'")');
						window.location='startday.html';
					}
				});
				//window.location='startday.html';
			}
		}
		else{
			jQuery('#myModal4').modal('hide');
		}
		
		var currenttime=getcurrenttime();
		var currentdatetime=getdatetime();
		var endtime=getcurrenttime();
		var endtime2=addasecondintime();
		db.transaction(startlunch, errorDB, successDB);
		function startlunch(tx){
			var q="SELECT * FROM job_schedule WHERE user_id=? AND job_date=? ORDER BY id DESC";
			var cond=[uid,today];
			tx.executeSql(q, cond, function(tx, res){
				if(parseInt(res.rows.length)>0){
					var sid=res.rows.item(0).id;
					var job_id=res.rows.item(0).job_id;
					var last_job_id=res.rows.item(0).job_id;
					var cdate=res.rows.item(0).cdate;
					var tms=cdate.split(' ');
					tx.executeSql('INSERT INTO job_schedule (job_id, startfrom, endto, job_date, last_job_id, user_id, cdate) VALUES ("'+job_id+'", "job", "office","'+today+'", "'+last_job_id+'", "'+uid+'", "'+currentdatetime+'")');
					
					tx.executeSql('INSERT INTO job_times (job_id, assigned_to, pu_date, start_time, end_time, time_type, cdate) VALUES ("'+job_id+'", "'+uid+'","'+today+'", "'+endtime+'", "'+endtime2+'","stopjob", "'+currentdatetime+'")');
					var qr="UPDATE job_daytimes set end_time='"+endtime+"', status='complete' WHERE start_date='"+today+"' AND user_id='"+uid+"'";
					tx.executeSql(qr);
					if(redirect){
						window.location='startday.html';
					}
				}
				else{
					var qr="UPDATE job_daytimes set end_time='"+endtime+"', status='complete' WHERE start_date='"+today+"' AND user_id='"+uid+"'";
					tx.executeSql(qr);
					localStorage.removeItem('timecount');
					localStorage.removeItem('timecount2');
					if(redirect){
						window.location='startday.html';
					}
				}
			});
			
		}
	});
	var clock_stop_for=localStorage.getItem('clock_stop_for_'+today);
	if(typeof clock_stop_for!='undefined' && clock_stop_for!='' && clock_stop_for!=null){
		if(clock_stop_for=='lunch'){
			jQuery('.starttodayjob').addClass('stopforlunch');
			jQuery('.startjob_status_text').html('Clocked out for lunch or break');
			setTimeout(function(){jQuery('.startjob_status_text').html('Clocked out for lunch or break');
			jQuery('.starttodayjob_times li').removeClass('clock_active');
			},1000);
		}
	}
	jQuery('.step2_stop_for_lunch').click(function(){
		var stop_today=localStorage.getItem('stop_today_'+today);
		if(stop_today!='stop'){
			localStorage.setItem('job_status_'+today,'lunchbreak');
			localStorage.setItem('startjob_status_text','Clocked out for lunch or break');
			localStorage.setItem('stop_job_clock_'+today,'stop');
			localStorage.setItem('stop_general_clock_'+today,'stop');
			localStorage.setItem('clock_stop_for_'+today,'lunch');
			var currentdatetime=getdatetime();
			var currenttime=getcurrenttime();
			localStorage.setItem('stop_lunch_'+today,currentdatetime);
			jQuery('.startjob_status_text').html('Clocked out for lunch or break');
			db.transaction(startlunch, errorDB, successDB);
			function startlunch(tx){
				var job_id=jQuery('#job_id').val();
				var q2="SELECT * FROM job_times WHERE pu_date=? AND assigned_to=? AND job_id=? AND time_type=?";
					var cond2=[today,uid,job_id,'startjob'];
					tx.executeSql(q2, cond2, function(tx, res2){
						if(parseInt(res2.rows.length)>0){
							var uq="UPDATE job_times set end_time='"+currenttime+"' WHERE pu_date='"+today+"' AND assigned_to='"+uid+"' AND job_id='"+job_id+"' AND time_type='startjob' AND end_time='00:00:00'";
							tx.executeSql(uq);
						}
						
					});
				tx.executeSql('INSERT INTO job_times (job_id, assigned_to, pu_date, start_time, time_type, cdate) VALUES ("'+job_id+'", "'+uid+'","'+today+'", "'+currenttime+'","lunch", "'+currentdatetime+'")');
			}
			jQuery('.starttodayjob').addClass('stopforlunch');
			clearInterval(counter);
			clearInterval(counter2);
			jQuery('#myModal2').modal('hide');
			jQuery('.stopforlunch').click(function(){
				localStorage.removeItem('stop_job_clock_'+today);
				localStorage.removeItem('stop_general_clock_'+today);
				localStorage.removeItem('clock_stop_for_'+today);
				localStorage.setItem('startjob_status_text','Clocked In: No Active Job');
				var currenttime=getcurrenttime();
				var currentdatetime=getdatetime();
				var currenttime2=addasecondintime();
				db.transaction(startlunch, errorDB, successDB);
				function startlunch(tx){
					var job_id=jQuery('#job_id').val();
					tx.executeSql("UPDATE job_times set end_time='"+currenttime+"' WHERE pu_date='"+today+"' AND assigned_to='"+uid+"' AND job_id='"+job_id+"' AND time_type='lunch' AND end_time='00:00:00'");
					tx.executeSql('INSERT INTO job_times (job_id, assigned_to, pu_date, start_time, time_type, cdate) VALUES ("'+job_id+'", "'+uid+'","'+today+'", "'+currenttime2+'","startjob", "'+currentdatetime+'")');
					window.location='';
				}
				
			});
		}
		jQuery('.job_clock_time').parents('li').removeClass('clock_active');
		//else{
			jQuery('#myModal2').modal('hide');
			jQuery('#myModal3').modal('hide');
		//}
	});
	jQuery('.stopforlunch').click(function(){
		jQuery('.job_clock_time').parents('li').removeClass('clock_active');
		localStorage.removeItem('stop_job_clock_'+today);
		localStorage.removeItem('stop_general_clock_'+today);
		localStorage.removeItem('clock_stop_for_'+today);
		localStorage.setItem('startjob_status_text','Clocked In: No Active Job');
		var currenttime=getcurrenttime();
		var currentdatetime=getdatetime();
		var currenttime2=addasecondintime();
		db.transaction(startlunch, errorDB, successDB);
		function startlunch(tx){
			var job_id=jQuery('#job_id').val();
			tx.executeSql("UPDATE job_times set end_time='"+currenttime+"' WHERE pu_date='"+today+"' AND assigned_to='"+uid+"' AND job_id='"+job_id+"' AND time_type='lunch' AND end_time='00:00:00'");
			tx.executeSql('INSERT INTO job_times (job_id, assigned_to, pu_date, start_time, time_type, cdate) VALUES ("'+job_id+'", "'+uid+'","'+today+'", "'+currenttime2+'","startjob", "'+currentdatetime+'")');
			window.location='';
		}
		
	});
	
	jQuery('.decline_job').click(function(){
		localStorage.setItem('job_status_'+today,'startgeneraltime');
		jQuery('.startjob_status_text').removeClass('offclock_st_color');
		jQuery('.general_clock_time').parents('li').addClass('glck');
		localStorage.setItem('startjob_status_text','Clocked In: No Active Job');
		jQuery('.startjob_status_text').html('Clocked In: No Active Job');
		jQuery('.startjob_status_text').addClass('decline_job_status');
		jQuery('.decline_job').parent('li').remove();
		jQuery('#myModal1').modal('hide');
		jQuery('#myModal1 .pop-btm-cnt:first ul li.clockoutmenu').remove();
		jQuery('#myModal1 .pop-btm-cnt:first ul').append('<li class="clockoutmenu"><a href="javascript:;" onclick="clockouttime();">Clock out for day</a></li>');
		clearInterval(counter);
		counter=setInterval(generaltimer, 1000);
		db.transaction(startdaytime, errorDB, successDB);
		function startdaytime(tx){
			var q="SELECT * FROM job_daytimes WHERE start_date=? AND user_id=?";
			var cond=[today,uid];
			tx.executeSql(q, cond, function(tx, res){
				if(parseInt(res.rows.length)>0){
					
				}
				else{
					
					tx.executeSql('INSERT INTO job_daytimes (start_date, start_time, user_id) VALUES ("'+today+'", "'+currenttime+'", "'+uid+'")');
				}
			});
		}
	});
	jQuery('.accept_job').click(function(){
		localStorage.setItem('job_status_'+today,'startgeneraltime');
		jQuery('.startjob_status_text').removeClass('offclock_st_color');
		jQuery('.general_clock_time').parents('li').addClass('glck');
		localStorage.setItem('startjob_status_text','Clocked In: No Active Job');
		jQuery('.startjob_status_text').html('Clocked In: No Active Job');
		jQuery('.startjob_status_text').addClass('decline_job_status');
		jQuery('.decline_job').parent('li').remove();
		jQuery('#myModal1').modal('hide');
		clearInterval(counter);
		var currenttime=getcurrenttime();
		counter=setInterval(generaltimer, 1000);
		db.transaction(startdaytime, errorDB, successDB);
		function startdaytime(tx){
			var q="SELECT * FROM job_daytimes WHERE start_date=? AND user_id=?";
			var cond=[today, uid];
			tx.executeSql(q, cond, function(tx, res){
				if(parseInt(res.rows.length)>0){
					
				}
				else{
					
					tx.executeSql('INSERT INTO job_daytimes (start_date, start_time, user_id) VALUES ("'+today+'", "'+currenttime+'", "'+uid+'")');
				}
			});
		}
		setTimeout(function(){
			window.location='today-jobs.html';
		},1200);
	});
	
	jQuery('.savenewnote').click(function(){
		var noerror=true;
		jQuery('#noteform textarea.required').each(function(){
			var v=jQuery(this).val();
			if(jQuery.trim(v)==''){
				jQuery(this).addClass('error');
				noerror=false;
			}
		});
		var job_id=jQuery('#job_id').val();
		var msg=jQuery('#notemsg').val();
		var currentdatetime=getdatetime();
		if(noerror){
			db.transaction(addnewnotes, errorDB, successDB);
			function addnewnotes(tx){
				var q="SELECT * FROM userlogin WHERE user_id=?";
				var cond=[uid];
				tx.executeSql(q, cond, function(tx, res){
					if(parseInt(res.rows.length)>0){
						
						var fname=res.rows.item(0).fname;
						var lname=res.rows.item(0).lname;
						var add_by=fname+' '+lname;
						tx.executeSql('INSERT INTO job_notifications (job_id, job_notification_id, title, message, add_by, cdate, nfrom, user_id) VALUES ("'+job_id+'", "0", "Note", "'+msg+'", "'+add_by+'", "'+currentdatetime+'", "app", "'+uid+'")');
						window.location='';
					}
				});
			}
		}
	});
	
	db.transaction(checkjobexusts, errorDB, successDB);
	function checkjobexusts(tx){
		var q="SELECT * FROM jobs WHERE job_date=? AND user_id=? AND status=?";
		var cond=[today,uid,'Assigned'];
		tx.executeSql(q, cond, function(tx, res){
			if(parseInt(res.rows.length)<=0){
				jQuery('.nojobexist').hide();
				
				//jQuery('.decline_job').text('Pick the job you want to clock into');
				var job_status=localStorage.getItem('job_status_'+today);
				if(job_status!='lunchbreak')
				{
					jQuery('#myModal2 .nojobexist a').text('Complete the job');
					jQuery('#myModal2 .nojobexist').show();
				}
				if(job_status!='lunchbreak' && job_status!='jobstart')
				{
					jQuery('.previous_notes').html('<button type="button" class="nf-box-btn addformbtn" onclick="synjobs();">Synchronize</button>');
				}
				else{
					jQuery('.starttodayjob').removeClass('step3');
					jQuery('.starttodayjob').addClass('step2');
					setTimeout(function(){
						jQuery('.starttodayjob').removeClass('step3');
						jQuery('.starttodayjob').addClass('step2');
					},2000);
				}
			}
			else{
				//jQuery('.decline_job').parent('li').hide();
				var job_status=localStorage.getItem('job_status_'+today);
				if(job_status=='lunchbreak')
				{
					jQuery('.starttodayjob').removeClass('step2');
					jQuery('.starttodayjob').addClass('step3');
					setTimeout(function(){
						jQuery('.starttodayjob').removeClass('step2');
						jQuery('.starttodayjob').addClass('step3');
					},2000);
				}
				
			}
		});
	}
	localStorage.setItem('gotopage2', 'startday.html');
	var recheck=gup('recheck');
	if(recheck=='1'){
		window.location='startday.html';
	}
});

</script>
</body>
</html>